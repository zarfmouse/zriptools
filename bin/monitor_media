#!/usr/bin/php
<?php

require_once __DIR__."/../lib/autoload-init.php";
require_once __DIR__."/../lib/doctrine-init.php";

use ZRipUtils\MediaMonitor;
use ZRipUtils\TaskManager;
use ZRipUtils\DiscId;
use ZRipTasks\RipAudio;
use ZCore\ProgressMonitor;

define('LIBRARY_ROOT', '/home/zach/CDLibrary');

$task_manager = new TaskManager;
$progress_monitor = new ProgressMonitor;
$task_manager->setProgressMonitor($progress_monitor);
$monitor = new MediaMonitor;

$monitor->registerAudioCDAction(function($device) use ($task_manager) {
    $task_manager->run(new RipAudio($device));
  });
$monitor->registerMultiModeCDAction(function($device) {
    $dev = $device->getDeviceFile();
    print "$dev - MultiMode CD.\n";
    system("eject $dev");
  });
$monitor->registerDataCDAction(function($device) {
    $dev = $device->getDeviceFile();
    print "$dev - Data CD.\n";
    system("eject $dev");
  });
$monitor->registerVideoDVDAction(function($device) {
    $dev = $device->getDeviceFile();
    print "$dev - Video DVD.\n";
    system("eject $dev");
  });
$monitor->registerDataDVDAction(function($device) {
    $dev = $device->getDeviceFile();
    print "$dev - Data DVD.\n";
    system("eject $dev");
  });
$monitor->registerEjectAction(function($device) {
    $dev = $device->getDeviceFile();
    print "$dev ejected.\n";
    $task_manager->reaper();
  });
$monitor->run();

